<!-- inside <script> tag, replace the whole window.onload part with this: -->
<script>
  window.onload = () => {
    let currentUser = "";
    let today = new Date().toLocaleDateString();
    let streak = { N: 0, M: 0 };

    document.getElementById('loginBtn').onclick = checkPassword;

    function checkPassword() {
      const pw = document.getElementById('password').value;
      if (pw === "1451") {
        currentUser = "N";
        document.body.style.backgroundColor = "#e6f7ff";
        startApp();
      } else if (pw === "1024") {
        currentUser = "M";
        document.body.style.backgroundColor = "#ffeef2";
        startApp();
      } else {
        alert("Wrong password");
      }
    }

    function startApp() {
      document.getElementById("login").classList.add("hidden");
      document.getElementById("main").classList.remove("hidden");
      document.getElementById("userIndicator").innerText = `You are logged in as: ${currentUser}`;
      loadOtherImage();
      loadStreak();
    }

    async function uploadImage(event) {
      const file = event.target.files[0];
      if (!file) return;

      const key = `${currentUser}_${today.replace(/\//g, '-')}`;
      const formData = new FormData();
      formData.append("file", file);
      formData.append("public_id", key);

      try {
        const response = await fetch("https://whisperframesbackend.onrender.com/upload", {
          method: "POST",
          body: formData
        });

        if (!response.ok) throw new Error("Upload failed");

        const data = await response.json();
        if (data.secure_url) {
          updateStreak();
          loadOtherImage(); // trigger reload with fresh timestamp
        } else {
          alert("Upload failed.");
        }
      } catch (err) {
        alert("Upload failed: " + err.message);
      }
    }

    function loadOtherImage() {
      const otherUser = currentUser === "N" ? "M" : "N";
      const key = `${otherUser}_${today.replace(/\//g, '-')}`;
      const cloudName = "dn678kfox";
      const timestamp = Date.now();
      const baseUrl = `https://res.cloudinary.com/${cloudName}/image/upload/f_auto/${key}`;
      const fullUrl = `${baseUrl}?t=${timestamp}`;

      const img = document.getElementById("otherImage");
      const downloadBtn = document.getElementById("downloadBtn");

      const tester = new Image();
      tester.onload = function () {
        img.src = fullUrl;
        downloadBtn.href = fullUrl;
        downloadBtn.classList.remove("hidden");
      };
      tester.onerror = function () {
        img.src = "https://res.cloudinary.com/dn678kfox/image/upload/v1690000000/nofilehing.png";
        downloadBtn.classList.add("hidden");
      };
      tester.src = fullUrl;
    }

    function updateStreak() {
      const key = currentUser + "_streak_date";
      const lastDate = localStorage.getItem(key);
      if (lastDate === today) return;

      const yesterday = new Date();
      yesterday.setDate(yesterday.getDate() - 1);
      const yDate = yesterday.toLocaleDateString();

      if (lastDate === yDate) {
        streak[currentUser] = (parseInt(localStorage.getItem(currentUser + "_streak")) || 0) + 1;
      } else {
        streak[currentUser] = 1;
      }

      localStorage.setItem(currentUser + "_streak_date", today);
      localStorage.setItem(currentUser + "_streak", streak[currentUser]);
      loadStreak();
    }

    function loadStreak() {
      const count = parseInt(localStorage.getItem(currentUser + "_streak")) || 0;
      document.getElementById("streakCount").innerText = count;
    }

    function resetApp() {
      location.reload();
    }

    window.uploadImage = uploadImage;
    window.resetApp = resetApp;
  };
</script>




